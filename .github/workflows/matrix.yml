---
jobs:
  build:
    name: "${{ inputs.flags || 'Default' }}"
    runs-on: '${{ inputs.os }}'
    steps:
      - id: cache-perl
        name: Check perl Cache
        uses: actions/cache@v4
        with:
          key: '${{ inputs.os }}-perl-v${{ inputs.perl }}${{ inputs.flags }}'
          path: '~/perl5/'
      - if: "${{ steps.cache-perl.outputs.cache-hit != 'true' }}"
        name: 'Build perl ${{ inputs.perl }} from source'
        shell: bash
        run: |
          git clone --depth 1 --branch v${{inputs.perl}} https://github.com/Perl/perl5.git

          if [[ '${{ runner.os }}' == 'Windows' ]]; then
            cd perl5/win32
            gmake CCHOME=C:\strawberry\c INST_TOP="C:\Users\runneradmin\perl5\perlbrew" ${{ matrix.flags == '--64int'        && 'USE_64_BIT_INT=define'                   || '' }} ${{ matrix.flags == '--thread'       && 'USE_ITHREADS=define    USE_MULTI=define' || '' }} ${{ matrix.flags == '--ld'           && 'USE_LONG_DOUBLE=define'                  || '' }} ${{ matrix.flags == '--multi'        && 'USE_MULTI=define'                        || '' }} ${{ matrix.flags == '-Dusequadmath'  && 'USE_QUADMATH=define' || '' }} ${{ matrix.flags == '--32bit'        && 'WIN64=undef'                             || '' }} -f GNUMakefile -j2 install
          else
            cd perl5
            sh Configure -des -Dinstallprefix=~/perl5 ${{ inputs.flags }}
            make -j5
            make install
          fi
      - id: version
        name: Report Perl Version
        shell: bash
        run: |

          if [[ '${{ runner.os }}' == 'Windows' ]]; then
            echo Windows
            set PATH=~/perl5/bin;%PATH%
          else
            echo Not Windows
            export PATH=~/perl5/bin:$PATH
            ~/perl5/bin/perl -V
          fi

          perl -V
#          ~/perl5/bin/perl -e 'print $^V' > test-output-${{ inputs.os }}-${{ inputs.perl }}${{ inputs.flags }}.txt
      #~ - name: Try it again...
        #~ run: perl -V
      - name: Upload results as artifact
        uses: actions/upload-artifact@v4.0.0
        with:
          if-no-files-found: error
          name: 'test-output-${{ inputs.os }}-${{ inputs.perl }}${{ inputs.flags }}'
          path: 'test-output-${{ inputs.os }}-${{ inputs.perl }}${{ inputs.flags }}.txt'
          retention-days: 1
name: Matrix module
on:
  workflow_call:
    inputs:
      flags:
        required: true
        type: string
      os:
        required: true
        type: string
      perl:
        required: true
        type: string
